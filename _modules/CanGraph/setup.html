
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CanGraph.setup &#8212; CanGraph 1.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="shortcut icon" href="../../_static/cangraph-mini.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/cangraph-logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Main Page
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Downloads.html">
   Downloads
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Other%20Reading%20Material.html">
     Other Reading Material
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Installing%20CanGraph.html">
     Installing CanGraph
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Running%20the%20Software.html">
     Running the Software
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Understanding%20its%20Outputs.html">
     Understanding its Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.pablomarcos.me/es/posts/master-en-biolog%c3%ada-computacional/tfm/">
   Presentations
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../CanGraph.html">
   CanGraph package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.ExposomeExplorer.html">
     CanGraph.ExposomeExplorer package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.GraphifyDrugBank.html">
     CanGraph.GraphifyDrugBank package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.GraphifyHMDB.html">
     CanGraph.GraphifyHMDB package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.GraphifySMPDB.html">
     CanGraph.GraphifySMPDB package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.MeSHandMetaNetX.html">
     CanGraph.MeSHandMetaNetX package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../CanGraph.QueryWikidata.html">
     CanGraph.QueryWikidata package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Install%20Apptainer.html">
     Install Apptainer
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ToDoList.html">
   To-Do List
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Logo by <a href="https://www.instagram.com/danonino.caducado/"> Daniel Marcos </a> </br>
                     Website by <a href="https://www.pablomarcos.me/"> Pablo Marcos </a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/OMB-IARC/CanGraph/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OMB-IARC/CanGraph//issues/new?title=Issue%20on%20page%20%2F_modules/CanGraph/setup.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for CanGraph.setup</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># SPDX-FileCopyrightText: 2022 Pablo Marcos &lt;software@loreak.org&gt;</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: MIT</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A python module that prepares the local environment, to be able to run the :obj:`~CanGraph.main`</span>
<span class="sd">and :obj:`~CanGraph.deploy` functions. This can be either run in an interactive way, requiring</span>
<span class="sd">user input; or in a automatic way, in order to pre-configure things, for example, if you are using</span>
<span class="sd">the singularity package</span>

<span class="sd">CanGraph.setup Usage</span>
<span class="sd">---------------------</span>

<span class="sd">To use this module:</span>

<span class="sd">.. argparse::</span>
<span class="sd">   :module: CanGraph.setup</span>
<span class="sd">   :func: args_parser</span>
<span class="sd">   :prog: python3 setup.py</span>
<span class="sd">   :nodefault:</span>

<span class="sd">CanGraph.setup Functions</span>
<span class="sd">-------------------------</span>

<span class="sd">This module is comprised of:</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Import external modules necessary for the script</span>
<span class="kn">import</span> <span class="nn">neo4j</span>                         <span class="c1"># Import the whole package for error management</span>
<span class="kn">from</span> <span class="nn">neo4j</span> <span class="kn">import</span> <span class="n">GraphDatabase</span>      <span class="c1"># The Neo4J python driver</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">shutil</span>               <span class="c1"># Vital modules to interact with the filesystem</span>
<span class="kn">import</span> <span class="nn">re</span>                            <span class="c1"># Work with regular expressions</span>
<span class="kn">import</span> <span class="nn">time</span>                          <span class="c1"># Manage the time, and wait times, in python</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>          <span class="c1"># Work with ZIP files</span>
<span class="kn">import</span> <span class="nn">subprocess</span>                    <span class="c1"># Manage python sub-processes</span>
<span class="kn">import</span> <span class="nn">logging</span>                       <span class="c1"># Make ``verbose`` messages easier to show</span>
<span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>                <span class="c1"># For now, used to generate passwords</span>
<span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span>                 <span class="c1"># Manage Git directly from Python</span>
<span class="kn">import</span> <span class="nn">psutil</span>                        <span class="c1"># Kill the burden of the neo4j process</span>
<span class="kn">import</span> <span class="nn">argparse</span>                      <span class="c1"># Arguments pàrser for Python</span>
<span class="kn">from</span> <span class="nn">texttable</span> <span class="kn">import</span> <span class="n">Texttable</span>      <span class="c1"># Draw cute tables in python</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>                  <span class="c1"># Analysis of tabular data</span>
<span class="kn">import</span> <span class="nn">json</span>                          <span class="c1"># Read JSON files from Python</span>
<span class="kn">from</span> <span class="nn">alive_progress</span> <span class="kn">import</span> <span class="n">alive_bar</span> <span class="c1"># A cute progress bar that shows the script is still running</span>
<span class="kn">import</span> <span class="nn">ijson</span>                         <span class="c1"># Read JSON files from Python in an iterative way</span>

<span class="kn">import</span> <span class="nn">miscelaneous</span> <span class="k">as</span> <span class="nn">misc</span>          <span class="c1"># A collection of useful functions</span>

<span class="c1"># ********* Miscelaneous functions ********* #</span>

<div class="viewcode-block" id="args_parser"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.args_parser">[docs]</a><span class="k">def</span> <span class="nf">args_parser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the command line arguments into a more usable form, providing help and more</span>

<span class="sd">    Returns:</span>
<span class="sd">        argparse.ArgumentParser:</span>
<span class="sd">            A dictionary of the different possible options for the program as keys, specifying their set value.</span>
<span class="sd">            If no command-line arguments are provided, the help message is shown and the program exits.</span>

<span class="sd">    .. NOTE:: Note that, in Google Docstrings, if you want a multi-line ``Returns`` comment,</span>
<span class="sd">        you have to start it in a different line :(</span>
<span class="sd">    .. NOTE:: The return **must** be of type :obj:`argparse.ArgumentParser` for the ``argparse``</span>
<span class="sd">        directive to work and auto-gen docs</span>
<span class="sd">    .. NOTE:: The ``--all```option has to be adressed outside of this function in order to not</span>
<span class="sd">        mess up the ``argparse`` directive in sphinx</span>
<span class="sd">    .. NOTE:: By using :obj:`argparse.const` instead of :obj:`argparse.default`, the check_file function will check &quot;&quot;</span>
<span class="sd">        (the current dir, always exists) if the arg is not provided, not breaking the function; if it is, it checks it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;A python module that prepares the local environment, to be able to run the CanGraph.main &quot;</span>
                      <span class="s2">&quot;and CanGraph.deploy functions.&quot;</span>
        <span class="c1"># formatter_class=argparse.ArgumentDefaultsHelpFormatter</span>
        <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--interactive&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;tells the script if it wants interaction from the user &quot;</span>
                              <span class="s2">&quot;and information shown to them; similar to --verbose&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--all&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;runs all the options below at once; equivalent to -dgnr; &quot;</span>
                              <span class="s2">&quot;it DOES NOT activate the interactive mode&quot;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dbfolder&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s2">&quot;DataBases&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set up the databases from which the program will pull its info using the provided folder&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--git&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s2">&quot;.git&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prepare the git environment for the deploy script using the provided git folder&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--requirements&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;installs all the requirements needed for all the possible options from the given requirements file&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--neo4j&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s2">&quot;neo4j&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set up  the neo4j local environment, to run from the provided folder&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--neo4j_username&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;neo4j&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the username for the neo4j database&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--neo4j_password&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;neo4j&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the password for the neo4j database&quot;</span><span class="p">)</span>

    <span class="c1"># If no args are provided, show the help message</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span></div>

<span class="c1"># ********* Add some verbose messages ********* #</span>

<div class="viewcode-block" id="initial_message"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.initial_message">[docs]</a><span class="k">def</span> <span class="nf">initial_message</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompts the user with an initial message if the session is set to be interactive.</span>

<span class="sd">    Args:</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hi! This setup script will guide you through the necessary steps to prepare &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;for the running of the main script&quot;</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This is because most of the databases we are using are confidential,&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;so we cannot bundle them in the module. Also, we didn&#39;t include neo4j&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in the main repo to keep it light and due to copyright concerns&quot;</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fortunately, you will only need to run the setup once if you use the --all &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;option; and, if everything is ready, you can just directly run main.py &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(please read its README for more instructions on usage)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="final_message"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.final_message">[docs]</a><span class="k">def</span> <span class="nf">final_message</span><span class="p">(</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompts the user with a final message.</span>

<span class="sd">    Args:</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If you selected the --all option, you may now proceed to run the main script;&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in any other case, please make sure the parts relevant to the code you will &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;run are propperly configure (you may call ``python3 setup.py --help`` for more &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;info on available options)&quot;</span><span class="p">)</span>

    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<span class="c1"># ********* Install the requirements ********* #</span>

<div class="viewcode-block" id="install_packages"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.install_packages">[docs]</a><span class="k">def</span> <span class="nf">install_packages</span><span class="p">(</span><span class="n">requirements_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">package_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automates installing packages using PIP</span>

<span class="sd">    Args:</span>
<span class="sd">        requirements_file (str): The path to a &quot;requirements.txt&quot; file, containing one requirement per line</span>
<span class="sd">        package_name (str): A package to be installed</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If neither a ``requirements_file`` nor a ``package_name`` is provided</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for and installing packages using PIP...&quot;</span><span class="p">)</span>

    <span class="n">quiet</span> <span class="o">=</span> <span class="s2">&quot;--quiet&quot;</span> <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">requirements_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">requirements_file</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quiet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">package</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quiet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must give at least one requirement to install&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span> <span class="c1"># Raise error if error is found</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">Error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> exited with Error: </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installed Requirements&quot;</span><span class="p">)</span></div>

<span class="c1"># ********* Set Up the Git environment for the deploy script ********* #</span>

<div class="viewcode-block" id="setup_git"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_git">[docs]</a><span class="k">def</span> <span class="nf">setup_git</span><span class="p">(</span><span class="n">path_to_repo</span> <span class="o">=</span> <span class="s2">&quot;.git&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set Up the Git environment for the :obj:`~CanGraph.deploy` script. It does so by removing</span>
<span class="sd">    any existing remotes and setting two new ones: github and codeberg, with their respective branches</span>

<span class="sd">    Args:</span>
<span class="sd">        path_to_repo (str): The path to the Git repo; by default, ``.git``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove any existing remotes so that they dont interfere</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now, I will set up the git environment so that the deploy functions may work&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First, let me remove any existing remotes&quot;</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path_to_repo</span><span class="p">)</span>
    <span class="n">remotes</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">remote</span> <span class="ow">in</span> <span class="n">remotes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;rm&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">)</span>

    <span class="c1"># Replace them with the new, canonic ones</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;And replace them with the new ones&quot;</span><span class="p">)</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="s2">&quot;https://github.com/OMB-IARC/CanGraph&quot;</span><span class="p">)</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;codeberg&quot;</span><span class="p">,</span> <span class="s2">&quot;https://codeberg.org/FlyingFlamingo/CanGraph&quot;</span><span class="p">)</span>

    <span class="c1"># Finally, set the remotes to track the correct branches</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finally, set each branch to track the correct remotes...&quot;</span><span class="p">)</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;--all&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The git is now configured :p&quot;</span><span class="p">)</span></div>

<span class="c1"># ********* Manage the Neo4J Database location, status and credentials ********* #</span>

<div class="viewcode-block" id="find_neo4j_installation_status"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.find_neo4j_installation_status">[docs]</a><span class="k">def</span> <span class="nf">find_neo4j_installation_status</span><span class="p">(</span><span class="n">neo4j_home</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">neo4j_username</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">neo4j_password</span><span class="o">=</span><span class="s2">&quot;neo4j&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the installation status of Neo4J by trying to use it normally, and analyzing any thrown exceptions</span>

<span class="sd">    Args:</span>
<span class="sd">        neo4j_home (str): the installation directory for the ``neo4j`` program; by default, ``neo4j``</span>
<span class="sd">        neo4j_username (str): the username for the neo4j database; by default ``neo4j``</span>
<span class="sd">        neo4j_password (str): the password for the neo4j database; by default ``neo4j``</span>

<span class="sd">    Returns:</span>
<span class="sd">        list:</span>
<span class="sd">            A list of two booleans: whether neo4j exists at ``neo4j_home``,</span>
<span class="sd">            and whether the supplied credentials are valid or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, declare the return variables as False by default</span>
    <span class="n">neo4j_exists</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">default_credentials</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># And set neo4j_home as an absolute path, in order to standardize</span>
    <span class="n">neo4j_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="c1"># To find out neo4j&#39;s installation status, we will try to run it and use possible exceptions</span>
    <span class="c1"># as a hint as to whether there are problems or not.</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Fist, we try to start neo4j using the Linux executable</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span><span class="si">}</span><span class="s2">/bin/neo4j&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">],</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;I see you do have Neo4J already installed and working!&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now, lets start it and check if it presents a known user/password pair&quot;</span><span class="p">)</span>

        <span class="c1"># If no exceptions are thrown, then it exists! Lets try to start it then</span>
        <span class="n">neo4j_exists</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">misc</span><span class="o">.</span><span class="n">sleep_with_counter</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Waiting for neo4j to start...&quot;</span><span class="p">)</span>

        <span class="n">driver</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">connect_to_neo4j</span><span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span>
                                       <span class="n">username</span> <span class="o">=</span> <span class="n">neo4j_username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">neo4j_password</span><span class="p">)</span>

        <span class="c1"># We will try to get the Import Path just as a test to see if the default auths are present</span>
        <span class="k">def</span> <span class="nf">allow_test_to_fail</span><span class="p">(</span><span class="n">tx</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">tx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; Call dbms.listConfig() YIELD name, value</span>
<span class="s2">            WHERE name=&#39;dbms.directories.import&#39; RETURN value &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">Neo4JImportPath</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute_read</span><span class="p">(</span><span class="n">allow_test_to_fail</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If there are no exceptions, obviously, then the credentials you supplied us with are working!</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installation with known credentials found! I&#39;ll work with that :p&quot;</span><span class="p">)</span>
        <span class="n">default_credentials</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># If it throws an ``AuthError``, its because the credentials are not the default</span>
    <span class="k">except</span> <span class="n">neo4j</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AuthError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Neo4J credentials are not known. We will need to re-install...&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Let me stop neo4j first...&quot;</span><span class="p">)</span>
        <span class="n">default_credentials</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># If they the default (neo4j/neo4j), it throws a ``ClientError``, because it requires a password change</span>
    <span class="k">except</span> <span class="n">neo4j</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installation with known credentials found! I&#39;ll work with that :p&quot;</span><span class="p">)</span>
        <span class="n">default_credentials</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># If the executable is not found in ``neo4j_home``. we will need to install it</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Neo4J installation has been found. Defaulting to installing from website...&quot;</span><span class="p">)</span>
        <span class="n">neo4j_exists</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># In any other case, re-install it, too</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An unknown error has been raised. Defaulting to installing from website...&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error was: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">neo4j_exists</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">misc</span><span class="o">.</span><span class="n">kill_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">neo4j_exists</span><span class="p">,</span> <span class="n">default_credentials</span></div>

<div class="viewcode-block" id="install_neo4j"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.install_neo4j">[docs]</a><span class="k">def</span> <span class="nf">install_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;4.4.0&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Installs the neo4j database program in the ``neo4j_home`` folder, by getting it from the internet</span>
<span class="sd">    according to the Operating System the script is been run in (aims for multi-platform!)</span>

<span class="sd">    Args:</span>
<span class="sd">        neo4j_home (str): the installation directory for the ``neo4j`` program; by default, ``neo4j``</span>
<span class="sd">        interactive (str): tells the script if it wants interaction from the user and information shown to them</span>
<span class="sd">        version (str): the version of the neo4j software that we wish to install</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">neo4j_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>
    <span class="n">neo4j_relt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="c1"># And install the neo4j executable</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I need to use folder </span><span class="si">{</span><span class="n">neo4j_relt</span><span class="si">}</span><span class="s2"> to store the neo4j program, but path </span><span class="si">{</span><span class="n">neo4j_relt</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Allow me to remove it? [Y/n]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please fix the folder situation. Exiting...&quot;</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Installing neo4j in </span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">if</span>  <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux1&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux2&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">download_and_untargz</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://neo4j.com/artifact.php?name=neo4j-community-</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">-unix.tar.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/&quot;</span><span class="p">)</span>
    <span class="k">elif</span>  <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">download_and_untargz</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://neo4j.com/artifact.php?name=neo4j-community-</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">-windows.zip&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/tmp/neo4j-community-</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="n">neo4j_home</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installation done!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_neo4j_confs"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.update_neo4j_confs">[docs]</a><span class="k">def</span> <span class="nf">update_neo4j_confs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">conf_file</span> <span class="o">=</span> <span class="s2">&quot;neo4j/conf/neo4j.conf&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates a preference on neo4j&#39;s ``conf_file``, given its name (``key``) and its expected ``value``</span>
<span class="sd">    If a preference is set with a value other than ``key``, said value will be overwritten; if it is commented,</span>
<span class="sd">    it will be uncommented (thanks to regex!)</span>

<span class="sd">    Args:</span>
<span class="sd">        conf_file (str): The location for ne4j&#39;s configuration file; usually, it should be ``neo4j/conf/neo4j.conf``</span>
<span class="sd">        key (str): The key for neo4j&#39;s configuration parameter that is being set up</span>
<span class="sd">        value (str): The value for said parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_conf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.old&quot;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">conf_file</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">)</span>
    <span class="n">conf_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_conf</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
        <span class="n">conf_text</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">search_term</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;\.&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conf_text</span><span class="p">:</span>
            <span class="n">conf_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;\#?</span><span class="si">{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">=.*&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conf_text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf_text</span> <span class="o">=</span> <span class="n">conf_text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conf_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf_text</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_conf</span><span class="p">)</span></div>

<div class="viewcode-block" id="configure_neo4j"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.configure_neo4j">[docs]</a><span class="k">def</span> <span class="nf">configure_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modifies the Neo4J conf file according to some recommendations provided by ``memrec``, neo4j&#39;s</span>
<span class="sd">    memory recommendator. It also enables the Awesome Procedures On Cypher (APOC) plugin from</span>
<span class="sd">    Neo4j Labs, and enables other basic confs such as file export and import or bigger timeouts</span>

<span class="sd">    Args:</span>
<span class="sd">        neo4j_home (str): the installation directory for the ``neo4j`` program; by default, ``neo4j``</span>

<span class="sd">    .. NOTE:: In order to make the setup more consistent, this function also forces the Neo4JImportPath</span>
<span class="sd">        (``dbms.directories.import``) to be presented in an absolute way, instead of being relative</span>
<span class="sd">        to ``neo4j_home``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neo4j_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now, lets configure the neo4j environment&quot;</span><span class="p">)</span>

    <span class="c1"># Enable the APOC plugin</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First, let me enable the APOC plugin, which we will use heavily...&quot;</span><span class="p">)</span>

    <span class="n">apoc_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;apoc\-.*\-core\.jar&#39;</span><span class="p">)</span>
    <span class="n">files_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/labs/&quot;</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">apoc_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">apoc_location</span> <span class="o">=</span> <span class="n">apoc_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/plugins/</span><span class="si">{</span><span class="n">apoc_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/labs/</span><span class="si">{</span><span class="n">apoc_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/plugins/</span><span class="si">{</span><span class="n">apoc_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># And modify the ``conf`` file</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;And, now, I will modify the conf file to update the preferences &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;based on sugestions provided by neo4j-admin&#39;s memrec feature&quot;</span><span class="p">)</span>

    <span class="n">sp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/bin/neo4j-admin&quot;</span><span class="p">,</span> <span class="s2">&quot;memrec&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span> <span class="c1"># Raise error if error is found</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">Error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> exited with Error: </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dbms.&quot;</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">update_neo4j_confs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="n">update_neo4j_confs</span><span class="p">(</span><span class="s2">&quot;apoc.import.file.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">update_neo4j_confs</span><span class="p">(</span><span class="s2">&quot;apoc.export.file.enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">update_neo4j_confs</span><span class="p">(</span> <span class="s2">&quot;apoc.http.timeout.connect&quot;</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)</span>
    <span class="n">update_neo4j_confs</span><span class="p">(</span><span class="s2">&quot;apoc.http.timeout.read&quot;</span><span class="p">,</span> <span class="mi">180000</span><span class="p">)</span>

    <span class="c1"># Dont do this! It will kill transactions that want to happen!</span>
    <span class="c1"># update_neo4j_confs(&quot;dbms.memory.transaction.global_max_size&quot;, &quot;1024m&quot;)</span>

    <span class="c1"># Force the &quot;import&quot; path to be absolute:</span>
    <span class="n">update_neo4j_confs</span><span class="p">(</span><span class="s2">&quot;dbms.directories.import&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/import&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="change_neo4j_password"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.change_neo4j_password">[docs]</a><span class="k">def</span> <span class="nf">change_neo4j_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="n">old_password</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">neo4j_home</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the neo4j password for user ``user``, from ``old_password`` to ``new_password``, by using a</span>
<span class="sd">    simple query in cypher-shell</span>

<span class="sd">    Args:</span>
<span class="sd">        neo4j_home (str): the installation directory for the ``neo4j`` program; by default, ``neo4j``</span>
<span class="sd">        new_password (str): the new password for the database</span>
<span class="sd">        old_password (str): the old password for the database, needed for identification.</span>
<span class="sd">        user (str): the user for which the password is being changed.</span>
<span class="sd">        database (str): the name of the database for which we want to modify the password.</span>
<span class="sd">            By default, it is ``system``, since Neo4J&#39;s community edition  only allows for one database</span>

<span class="sd">    .. WARNING:: DO NOT REMOVE THE TRY-EXCEPT BLOCK THAT ATTEMPTS TO CONNECT TO NEO4J:</span>
<span class="sd">        It somehow magically maked the passsword change work. IT WILL NOT WORK IF THAT LINES ARE NOT PRESENT</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">neo4j_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span> <span class="c1"># Make the path absolute, to standardize</span>

    <span class="c1"># Restart the Neo4J database where we want to operate</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/bin/neo4j&quot;</span><span class="p">,</span> <span class="s2">&quot;restart&quot;</span><span class="p">],</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">connect_to_neo4j</span><span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;bolt://localhost:7687&quot;</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">allow_test_to_fail</span><span class="p">(</span><span class="n">tx</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">tx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; Call dbms.listConfig() YIELD name, value</span>
<span class="s2">            WHERE name=&#39;dbms.directories.import&#39; RETURN value &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">Neo4JImportPath</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute_read</span><span class="p">(</span><span class="n">allow_test_to_fail</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">misc</span><span class="o">.</span><span class="n">sleep_with_counter</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Waiting for neo4j to start...&quot;</span><span class="p">)</span>

    <span class="c1"># Alter the password using cypher-shell</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">neo4j_home</span><span class="si">}</span><span class="s2">/bin/cypher-shell&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">database</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old_password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;ALTER CURRENT USER SET PASSWORD FROM &#39;</span><span class="si">{</span><span class="n">old_password</span><span class="si">}</span><span class="s2">&#39; TO &#39;</span><span class="si">{</span><span class="n">new_password</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">],</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span> <span class="c1"># Raise error if error is found</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">Error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> exited with Error: </span><span class="si">{</span><span class="n">Error</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">misc</span><span class="o">.</span><span class="n">kill_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span> <span class="c1"># Kill the Neo4J process</span></div>

<div class="viewcode-block" id="setup_neo4j"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_neo4j">[docs]</a><span class="k">def</span> <span class="nf">setup_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">neo4j_username</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">neo4j_password</span> <span class="o">=</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets ups the neo4j environment in ``neo4j_home``, so that the functions in :obj:`~CanGraph.main` can propperly</span>
<span class="sd">    function. Using the functions present in this module, it finds if neo4j is installed with default credentials,</span>
<span class="sd">    and, if not, it installs it, changing the default password to a new one, and returning its value</span>

<span class="sd">    Args:</span>
<span class="sd">        neo4j_home (str): the installation directory for the ``neo4j`` program; by default, ``neo4j``</span>
<span class="sd">        neo4j_username (str): the username for the neo4j database; by default ``neo4j``</span>
<span class="sd">        neo4j_password (str): the password for the neo4j database; by default ``neo4j``</span>
<span class="sd">        interactive (str): tells the script if it wants interaction from the user and information shown to them</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The password that was set up for the new neo4j database. This is also written to .neo4jpassword</span>

<span class="sd">    .. NOTE:: This has been designed to be used with a ``neo4j_home`` located in the WorkDir, but can be used</span>
<span class="sd">        in any other location with read/write access, or even with ``apt install`` installed versions! Just</span>
<span class="sd">        find its ``neo4j_home``, make sure it has r/w access, and provide it to the program!</span>
<span class="sd">    .. NOTE:: If no neo4j_password is provided or if neo4j_password = &quot;neo4j&quot;, the function will check for a previously</span>
<span class="sd">        created &quot;.neo4jpassword&quot; file, signalling a possible pre-existing database with known credentials</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Fist, we need to kill any existing neo4j instances. As explained in :obj:`~CanGraph.miscelaneous.kill_neo4j`,</span>
    <span class="c1">#this is because the process may be lingering on otherwise, making the program crash</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">):</span> <span class="n">misc</span><span class="o">.</span><span class="n">kill_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="c1"># Display an initial message</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now, lets set up the Neo4J environment&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First, I will check for an existing Neo4J installation with the default&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;user/passwd, as this might save time.&quot;</span><span class="p">)</span>

    <span class="c1"># Set the variables that will help us find the status of neo4j&#39;s installation to ``False`` by default</span>
    <span class="n">neo4j_exists</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">default_credentials</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check for existing credentials</span>
    <span class="k">if</span> <span class="n">neo4j_password</span> <span class="o">==</span> <span class="s2">&quot;neo4j&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;.neo4jpassword&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;.neo4jpassword&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">password_file</span><span class="p">:</span>
            <span class="n">old_password</span> <span class="o">=</span> <span class="n">password_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">old_password</span> <span class="o">=</span> <span class="n">neo4j_password</span>

    <span class="c1"># Find out the status of neo4j installation</span>
    <span class="n">neo4j_exists</span><span class="p">,</span> <span class="n">default_credentials</span> <span class="o">=</span> <span class="n">find_neo4j_installation_status</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">,</span> <span class="n">neo4j_username</span><span class="p">,</span> <span class="n">old_password</span><span class="p">)</span>

    <span class="c1"># If needed, install neo4j</span>
    <span class="k">if</span> <span class="n">neo4j_exists</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">default_credentials</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">install_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">,</span> <span class="n">interactive</span><span class="p">)</span>

        <span class="c1"># In which case, we will need to re-generate the password (or change it if its the default and thus errors)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now, let me generate a new password for the neo4j database and establish it&quot;</span><span class="p">)</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>

        <span class="n">change_neo4j_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neo4J&#39;s password has been set to: </span><span class="si">{</span><span class="n">new_password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;.neo4jpassword&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">password_file</span><span class="p">:</span>
            <span class="n">password_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This password has been written to ``.neo4jpassword``&quot;</span><span class="p">)</span>

    <span class="c1"># If the credentials provided are OK, then no need to change anything of course</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">new_password</span> <span class="o">=</span> <span class="n">old_password</span>

    <span class="c1"># Finally, we configure the Neo4J environment. This might be duplicated, but checking</span>
    <span class="c1"># if the configs are already there will almost take the same time, so easier this way</span>
    <span class="n">configure_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="c1"># We Kill Neo4J one last time:</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">kill_neo4j</span><span class="p">(</span><span class="n">neo4j_home</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The neo4j environment is ready for use&quot;</span><span class="p">)</span> <span class="c1"># And done!</span>

    <span class="k">return</span> <span class="n">new_password</span></div>

<span class="c1"># ********* Set Up the DataBases from which the ``main`` function will get its data ********* #</span>

<div class="viewcode-block" id="setup_folders"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_folders">[docs]</a><span class="k">def</span> <span class="nf">setup_folders</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the ``databasefolder`` if it does not exist. If it does, it either asks</span>
<span class="sd">    before overwriting in ``interactive`` mode, or directly overwrites in auto mode.</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the Databases folder already exists (so as not to overwrite)</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if successful, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="c1"># If the path exists, remove it and create anew; else, pass</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I see you already have a </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> folder in this directory. &quot;</span>
                   <span class="s2">&quot;May we use it for the project? (We may ovewrite its contents!)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use existing folder? [Y/n]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>

        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please fix the folder situation. Exiting...&quot;</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created DataBases folder&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="check_exposome_files"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.check_exposome_files">[docs]</a><span class="k">def</span> <span class="nf">check_exposome_files</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks for the presence of all the files that should be in &quot;``databasefolder``/ExposomeExplorer&quot;`</span>
<span class="sd">    for the ExposomeExplorer part of the script to run</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>

<span class="sd">    Returns:</span>
<span class="sd">        str:</span>
<span class="sd">            One of [&quot;Splitted, &quot;UnSplitted&quot;, &quot;Error&quot;]. If &quot;Error&quot;,</span>
<span class="sd">            Exposome-Explorer should not be used as a data source;</span>
<span class="sd">            if &quot;UnSplitted&quot;, please split the &quot;components&quot; file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="c1"># Check for the presence of all files; if :obj:`CanGraph.miscelaneous.check_file`</span>
    <span class="c1"># throws an error, set exposome_explorer_ok to ``False``</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># First, we try with all the non-splittable files</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/units.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/subjects.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/specimens.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/samples.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/reproducibilities.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/publications.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/microbial_metabolite_identifications.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/metabolomic_associations.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/cancer_associations.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/measurements.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/experimental_methods.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/correlations.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/cohorts.csv&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/cancers.csv&quot;</span><span class="p">)</span>

        <span class="c1"># Then, for exposome: either the unexplitted file is present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components.csv&quot;</span><span class="p">)</span>
            <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="s2">&quot;UnSplitted&quot;</span>

        <span class="c1"># Or the UnSplitted files are present; to check for this, we take a random sample of 5 files</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1515</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/components_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
                <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="s2">&quot;Splitted&quot;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span>

    <span class="k">return</span> <span class="n">exposome_explorer_status</span></div>

<div class="viewcode-block" id="setup_exposome"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_exposome">[docs]</a><span class="k">def</span> <span class="nf">setup_exposome</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the files relative to the Exposome Explorer database in the ``databasefolder``,</span>
<span class="sd">    splitting them for easier processing later on. If the session is set to be interactive,</span>
<span class="sd">    the user will be given time to add the files themselves; if not, the full suite of necessary</span>
<span class="sd">    files will be checked for their presence in ``databasefolder``</span>

<span class="sd">    Then, the &quot;components&quot; file will be splitted into one record oer line,</span>
<span class="sd">    as :obj:`~CanGraph.main` requires</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool:</span>
<span class="sd">            True if everything went okay; False otherwise. If False,</span>
<span class="sd">            Exposome-Explorer should not be used as a data source</span>

<span class="sd">    .. WARNING:: When updating the Exposome Explorer DataBase Version, please</span>
<span class="sd">        edit :obj:`~CanGraph.setup.check_exposome_files` to reflect the correct number of files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>
    <span class="n">reldatabasedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="c1"># If interactive, ask the user to add the E-E CSVs and whether they approve of file split.</span>
    <span class="c1"># If not, just check for the presence of the files and split components without problem</span>
    <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="n">check_exposome_files</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up the Exposome Explorer database...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span><span class="p">:</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First, please put the appropriate CSVs &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;on the </span><span class="si">{</span><span class="n">reldatabasedir</span><span class="si">}</span><span class="s2">/ExposomeExplorer path&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This database is confidential, and CANNOT be found online. &quot;</span>
                     <span class="s2">&quot;Please ask IARC for the files in case you need them.&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Let me create said folder for you...&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Once you are ready, press [ENTER]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>

        <span class="c1"># If the user didn&#39;t add all the necessary files, exit</span>
        <span class="n">exposome_explorer_status</span> <span class="o">=</span> <span class="n">check_exposome_files</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some files where not found in the </span><span class="si">{</span><span class="n">reldatabasedir</span><span class="si">}</span><span class="s2">/ExposomeExplorer &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;folder. Please, revise that it is correctly setup&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All checks OK&quot;</span><span class="p">)</span>

        <span class="c1"># If everything is ok, ask the user for split permission</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now, I will split the some files into a number of one-liner CSVs, simplifying import&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please, bear in mind that I will remove some of the the original files to avoid problems; is that ok? [Y/n]:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You need to approve splitting for the setup to work. Exiting...&quot;</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;Splitted&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All files found on the </span><span class="si">{</span><span class="n">reldatabasedir</span><span class="si">}</span><span class="s2">/ExposomeExplorer path. Moving on...&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot fix the Exposome-Explorer DataBase in un-interactive mode. Skipping...&quot;</span><span class="p">)</span>

    <span class="c1"># Split the &quot;components&quot; files</span>
    <span class="k">if</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;UnSplitted&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">split_csv</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/ExposomeExplorer/&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">exposome_explorer_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="setup_hmdb"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_hmdb">[docs]</a><span class="k">def</span> <span class="nf">setup_hmdb</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the files relative to the HMDB database in the ``databasefolder``,</span>
<span class="sd">    splitting them for easier processing later on.</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool:</span>
<span class="sd">            True if everything went okay; False otherwise. If False,</span>
<span class="sd">            DrugBank should not be used as a data source</span>

<span class="sd">    .. WARNING:: When updating the Exposome Explorer DataBase Version, please</span>
<span class="sd">        edit :obj:`~CanGraph.setup.check_exposome_files` to reflect the correct number of files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up the Human Metabolome DataBase...&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I will download all the needed files and store them in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span><span class="si">}</span><span class="s2">/HMDB&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB&quot;</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Depending on your internet connection, this may take some time...&quot;</span><span class="p">)</span>

    <span class="c1"># The files in the HMDB database which we will download</span>
    <span class="n">hmdb_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://hmdb.ca/system/downloads/current/hmdb_proteins.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/urine_metabolites.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/serum_metabolites.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/csf_metabolites.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/saliva_metabolites.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/feces_metabolites.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://hmdb.ca/system/downloads/current/sweat_metabolites.zip&quot;</span>
                <span class="p">]</span>

    <span class="c1"># For each file in the list, check:</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">hmdb_urls</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span>
        <span class="n">splittag</span> <span class="o">=</span> <span class="s2">&quot;protein&quot;</span> <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;hmdb_proteins.xml&quot;</span> <span class="k">else</span> <span class="s2">&quot;metabolite&quot;</span>

        <span class="c1"># If it exists on full form</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">file_status</span> <span class="o">=</span> <span class="s2">&quot;UnSplitted&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> was found on </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> and will not be re-downloaded&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># If it exists on splitted form</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;hmdb_proteins&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8000</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;urine_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3750</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;serum_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">38000</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;csf_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">350</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;saliva_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;feces_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6500</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;sweat_metabolites&quot;</span><span class="p">:</span>
                    <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">80</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>

                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="n">file_status</span> <span class="o">=</span> <span class="s2">&quot;Splitted&quot;</span>

            <span class="c1"># And if none, download the file</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="n">misc</span><span class="o">.</span><span class="n">download_and_unzip</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB&quot;</span><span class="p">)</span>
                <span class="n">file_status</span> <span class="o">=</span> <span class="s2">&quot;UnSplitted&quot;</span>

        <span class="k">if</span> <span class="n">file_status</span> <span class="o">==</span> <span class="s2">&quot;UnSplitted&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unzipping file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">split_xml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/HMDB/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">splittag</span><span class="p">,</span> <span class="s2">&quot;hmdb&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Some waiting time to avoid overheating</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Everything OK&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="setup_smpdb"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_smpdb">[docs]</a><span class="k">def</span> <span class="nf">setup_smpdb</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the files relative to the SMPDB database in the ``databasefolder``,</span>
<span class="sd">    splitting them for easier processing later on.</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool:</span>
<span class="sd">            True if everything went okay; False otherwise. If False,</span>
<span class="sd">            DrugBank should not be used as a data source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up the Small Molecule Pathway DataBase...&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Since we have to download and unzip some files related, this may also take some time! :p&quot;</span><span class="p">)</span>

    <span class="c1"># Create the database folder if it does not previously exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/SMPDB&quot;</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/SMPDB&quot;</span><span class="p">)</span>

    <span class="n">smpdb_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://smpdb.ca/downloads/smpdb_pathways.csv.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://smpdb.ca/downloads/smpdb_metabolites.csv.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://smpdb.ca/downloads/smpdb_proteins.csv.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://smpdb.ca/downloads/sequences/smpdb_protein.fasta.zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://smpdb.ca/downloads/sequences/smpdb_gene.fasta.zip&quot;</span><span class="p">,</span>
                <span class="p">]</span>

    <span class="c1"># For each URL in the DataBase</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">smpdb_urls</span><span class="p">:</span>

        <span class="c1"># Calculate the basename of the files from SMPDB</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[:</span><span class="mi">2</span><span class="p">]);</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Assign if we want to check</span>
        <span class="n">filetocheck</span> <span class="o">=</span> <span class="n">basename</span> <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;smpdb_metabolites&quot;</span><span class="p">,</span> <span class="s2">&quot;smpdb_proteins&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">filename</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/SMPDB/</span><span class="si">{</span><span class="n">filetocheck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">filetocheck</span><span class="si">}</span><span class="s2"> was found on </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> and will not be re-downloaded&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading and Unzipping: </span><span class="si">{</span><span class="n">filetocheck</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">basename</span> <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;smpdb_metabolites&quot;</span><span class="p">,</span> <span class="s2">&quot;smpdb_proteins&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">download_and_unzip</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/SMPDB/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Since SMPDB already gives splitted files, there is no need for us to re-split! :p</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All checks OK&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="setup_drugbank"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_drugbank">[docs]</a><span class="k">def</span> <span class="nf">setup_drugbank</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the files relative to the SMPDB database in the ``databasefolder``,</span>
<span class="sd">    splitting them for easier processing later on.</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool:</span>
<span class="sd">            True if everything went okay; False otherwise. If False,</span>
<span class="sd">            DrugBank should not be used as a data source</span>

<span class="sd">    .. WARNING:: When updating the DrugBank DataBase Version, please</span>
<span class="sd">        edit this function to reflect the correct number of files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up the DrugBank database...&quot;</span><span class="p">)</span>

    <span class="c1"># If interactive, ask for DrugBank data to help the user download the data.</span>
    <span class="c1"># else, just check that the full_database file exists or that the splitted files exist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.xml&quot;</span><span class="p">);</span> <span class="n">drugbank_status</span> <span class="o">=</span> <span class="s2">&quot;UnSplitted&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: full database.xml was found on </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> and will not be re-downloaded&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">five_nbs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">12000</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database_</span><span class="si">{</span><span class="n">five_nbs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Splitted database was found on </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> and will not be re-processed&quot;</span><span class="p">)</span>
            <span class="n">drugbank_status</span> <span class="o">=</span> <span class="s2">&quot;Splitted&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">drugbank_status</span> <span class="o">=</span> <span class="s2">&quot;Error&quot;</span>

    <span class="k">if</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">drugbank_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span><span class="p">:</span>
        <span class="c1"># Create the databasefolder. If created, just ignore its contents and use it (no problem as</span>
        <span class="c1">#overwrite is not likely, and, if it happens, we dont care much)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank&quot;</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;If you have a DrugBank account, I can help you automate the process!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Do you have an account [Y/n]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Please, ask for a DrugBank account and run the script back. &quot;</span>
                        <span class="s2">&quot;The process must be approved by the DrugBank team, and may take a week or more.&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please introduce your DrugBank username: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please introduce your DrugBank password: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[F&quot;</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please introduce your DrugBank password: ********** HIDDEN **********&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading the full database using curl. &quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Since its 1.4 GB, this may take some time...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.zip&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.zip&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.xml&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.xml&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;curl -Lf --progress-bar -o </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.zip</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;-u </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2"> https://go.drugbank.com/releases/5-1-9/downloads/all-full-database&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cURL exited with error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Was your username/password OK?&quot;</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting files from the full zip...&quot;</span><span class="p">)</span>

        <span class="n">misc</span><span class="o">.</span><span class="n">unzip</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.zip&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.zip&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.xml&quot;</span><span class="p">);</span> <span class="n">drugbank_status</span> <span class="o">=</span> <span class="s2">&quot;UnSplitted&quot;</span>

    <span class="k">elif</span> <span class="n">interactive</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">drugbank_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot fix the DrugBank DataBase in un-interactive mode. Skipping...&quot;</span><span class="p">)</span>

    <span class="c1"># If everything went OK, split the ``full_database`` file into its components ( 1 record per line )</span>
    <span class="k">if</span> <span class="n">drugbank_status</span> <span class="o">==</span> <span class="s2">&quot;UnSplitted&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Splitting the contents of the full zip......&quot;</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">split_xml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/DrugBank/full database.xml&quot;</span><span class="p">),</span> <span class="s2">&quot;drug&quot;</span><span class="p">,</span> <span class="s2">&quot;drugbank&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Everything OK&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">drugbank_status</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="setup_database_index"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_database_index">[docs]</a><span class="k">def</span> <span class="nf">setup_database_index</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the index file for all the databases present in the ``databasefolder`` folder,</span>
<span class="sd">    which will helpfully reduce processing time a lot</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            A dictionary containing the index for all the databases in ``databasefolder``.</span>
<span class="sd">            This index will be written as JSON in ``databasefolder``/index.json</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the databasefolder to be an absolute path</span>
    <span class="n">databasefolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="c1"># First, we prepare a scan of all the files available on our &quot;DataBases&quot; folder</span>
    <span class="c1"># We will cycle through them later on to try and find the index keys</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">scan_folder</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="s2">&quot;index.json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="c1"># Prepare the dictionary which will hold the index</span>
    <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ChEBI_ID&quot;</span><span class="p">:{},</span> <span class="s2">&quot;HMDB_ID&quot;</span><span class="p">:{},</span> <span class="s2">&quot;InChI&quot;</span><span class="p">:{},</span> <span class="s2">&quot;MeSH_ID&quot;</span><span class="p">:{},</span> <span class="s2">&quot;Name&quot;</span><span class="p">:{}}</span>
    <span class="n">inchi_regexp</span> <span class="o">=</span> <span class="s2">&quot;InChI\=1S?\/[A-Za-z0-9\.]+(\+[0-9]+)?(\/[cnpqbtmsih][A-Za-z0-9\-\+\(\)\,\/\?\;\.]+)*(</span><span class="se">\&quot;</span><span class="s2">|\&lt;)&quot;</span>

    <span class="c1"># Declare the progress bar we will use:</span>
    <span class="k">with</span>  <span class="n">alive_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Generating Search Index...&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>

        <span class="c1"># And run the indexer!</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
            <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">databasefolder</span><span class="p">)</span>
            <span class="n">hmdb_ids</span><span class="p">,</span> <span class="n">mesh_ids</span><span class="p">,</span> <span class="n">inchis</span><span class="p">,</span> <span class="n">chebi_ids</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">if</span> <span class="s2">&quot;InChI&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">inchi_regexp</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="n">inchis</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;ExposomeExplorer/components&quot;</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">chebi_ids</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;chebi_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;alternative_names&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;alternative_names&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s2">&quot;SMPDB/smpdb_metabolites&quot;</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">chebi_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;ChEBI ID&quot;</span><span class="p">])</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;Metabolite Name&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s2">&quot;SMPDB/smpdb_proteins&quot;</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
                <span class="n">component</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="s2">&quot;Protein Name&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s2">&quot;&lt;chebi_id&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">chebi_ids</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;chebi_id&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/chebi_id&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                              <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;chebi_id&gt;.*&lt;/chebi_id&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;&lt;name&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                             <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;name&gt;.*&lt;/name&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;&lt;synonym&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;synonym&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/synonym&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                             <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;synonym&gt;.*&lt;/synonym&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;DrugBank&quot;</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;kind&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Name&lt;/kind&gt;</span><span class="se">\n</span><span class="s2">      &lt;value&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/value&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Name&lt;/kind&gt;</span><span class="se">\n</span><span class="s2">      &lt;value&gt;.*&lt;/value&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;HMDB&quot;</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;iupac_name&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;iupac_name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/iupac_name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;iupac_name&gt;.*&lt;/iupac_name&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;traditional_iupac&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;traditional_iupac&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/traditional_iupac&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;traditional_iupac&gt;.*&lt;/traditional_iupac&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;uniprot_name&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;uniprot_name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/uniprot_name&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;uniprot_name&gt;.*&lt;/uniprot_name&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;&lt;mesh-id&gt;&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">mesh_ids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;mesh-id&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/mesh-id&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                             <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&lt;mesh-id&gt;.*&lt;/mesh-id&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;HMDB&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">hmdb_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;HMDB\d\d\d\d\d&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">def</span> <span class="nf">create_and_append_to_index</span><span class="p">(</span><span class="n">item_list</span><span class="p">,</span> <span class="n">item_type</span><span class="p">,</span> <span class="n">relpath</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">]:</span>
                    <span class="n">index_dict</span><span class="p">[</span><span class="n">item_type</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">relpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_dict</span><span class="p">[</span><span class="n">item_type</span><span class="p">][</span><span class="n">item</span><span class="p">]:</span>
                        <span class="n">index_dict</span><span class="p">[</span><span class="n">item_type</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

            <span class="n">create_and_append_to_index</span><span class="p">(</span><span class="n">chebi_ids</span><span class="p">,</span> <span class="s2">&quot;ChEBI_ID&quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
            <span class="n">create_and_append_to_index</span><span class="p">(</span><span class="n">hmdb_ids</span><span class="p">,</span> <span class="s2">&quot;HMDB_ID&quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
            <span class="n">create_and_append_to_index</span><span class="p">(</span><span class="n">inchis</span><span class="p">,</span> <span class="s2">&quot;InChI&quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
            <span class="n">create_and_append_to_index</span><span class="p">(</span><span class="n">mesh_ids</span><span class="p">,</span> <span class="s2">&quot;MeSH_ID&quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
            <span class="n">create_and_append_to_index</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>

            <span class="n">bar</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving the index file...&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/index.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_dict</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">index_dict</span></div>

<div class="viewcode-block" id="setup_databases"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.setup_databases">[docs]</a><span class="k">def</span> <span class="nf">setup_databases</span><span class="p">(</span><span class="n">databasefolder</span> <span class="o">=</span> <span class="s2">&quot;./DataBases&quot;</span><span class="p">,</span> <span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set Up the ``databasefolder`` from where the :obj:`~CanGraph.main` script will take its data. It</span>
<span class="sd">    does so by creating or removing and re-creating the ``databasefolder``, and putting inside it, or</span>
<span class="sd">    asking/checking if the user has put inside, the necessary files</span>

<span class="sd">    Args:</span>
<span class="sd">        databasefolder (str): The main folder where all the databases we will be using are to be found</span>
<span class="sd">        interactive (bool): Whether the session is set to be interactive or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup_folders</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">,</span> <span class="n">interactive</span><span class="p">)</span>
    <span class="n">exposome_explorer_ok</span> <span class="o">=</span> <span class="n">setup_exposome</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">,</span> <span class="n">interactive</span><span class="p">)</span>
    <span class="n">drugbank_ok</span> <span class="o">=</span> <span class="n">setup_drugbank</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">,</span> <span class="n">interactive</span><span class="p">)</span>
    <span class="n">hmdb_ok</span> <span class="o">=</span> <span class="n">setup_hmdb</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>
    <span class="n">smpdb_ok</span> <span class="o">=</span> <span class="n">setup_smpdb</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following databases have been set up in the </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2"> folder:&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Texttable</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">add_rows</span><span class="p">([</span>
                <span class="p">[</span><span class="s1">&#39;Exposome Explorer&#39;</span><span class="p">,</span> <span class="s1">&#39;HMDB&#39;</span><span class="p">,</span> <span class="s1">&#39;SMPDB&#39;</span><span class="p">,</span> <span class="s1">&#39;DrugBank&#39;</span><span class="p">,</span> <span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;False&quot;</span> <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;True&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">exposome_explorer_ok</span><span class="p">,</span> <span class="n">hmdb_ok</span><span class="p">,</span> <span class="n">smpdb_ok</span><span class="p">,</span> <span class="n">drugbank_ok</span><span class="p">]]</span>
                <span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">draw</span><span class="p">())</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This is all! Since the WikiData and MetaNetX databases are auto-consulted &quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;using RDF, the only thing we have left is generating the search index!&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up search index for all the files in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
         <span class="n">misc</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/index.json&quot;</span><span class="p">)</span>
         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index file was found at </span><span class="si">{</span><span class="n">databasefolder</span><span class="si">}</span><span class="s2">/index.json and will not be re-generated&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">index_dict</span> <span class="o">=</span> <span class="n">setup_database_index</span><span class="p">(</span><span class="n">databasefolder</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following number of identifiers have been indexed:&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Texttable</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_rows</span><span class="p">([</span>
                    <span class="p">[</span><span class="s1">&#39;ChEBI_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HMDB_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;InChI&#39;</span><span class="p">,</span> <span class="s1">&#39;MeSH_ID&#39;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">],</span>
                    <span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_dict</span><span class="p">[</span><span class="s2">&quot;ChEBI_ID&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_dict</span><span class="p">[</span><span class="s2">&quot;HMDB_ID&quot;</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">index_dict</span><span class="p">[</span><span class="s2">&quot;InChI&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_dict</span><span class="p">[</span><span class="s2">&quot;MeSH_ID&quot;</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">index_dict</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">])]</span>
                    <span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">draw</span><span class="p">())</span></div>

<span class="c1"># ********* And, finally, the main function ********* #</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../CanGraph.html#CanGraph.setup.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function that executes the code</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Parse the command line arguments</span>
    <span class="c1"># Done first in order to show errors if bad commands are issued</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">args_parser</span><span class="p">();</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Enable the --all argument</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">requirements</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">git</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">neo4j</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dbfolder</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># If the session is set to be interactive, display the logging messages</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="c1"># In any case, disable excessive verbosity on the neo4j driver</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;neo4j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

    <span class="c1"># Only in interactive mode to avoid unnecessary waits</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
        <span class="n">initial_message</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting setup script&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
        <span class="n">install_packages</span><span class="p">(</span><span class="n">requirements_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">requirements</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">git</span><span class="p">:</span>
        <span class="n">setup_git</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">git</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dbfolder</span><span class="p">:</span>
        <span class="n">setup_databases</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dbfolder</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">interactive</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neo4j</span><span class="p">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">setup_neo4j</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">neo4j</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">neo4j_username</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">neo4j_password</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
        <span class="n">final_message</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The setup script has ended successfully&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">password</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pablo Marcos<br/>
  
      &copy; Copyright 2022, Pablo Marcos &lt;software@loreak.org&gt;.<br/>
    Last updated on Dec 17, 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>